---
export interface Props {
  url: string;
}

const { url } = Astro.props;

// URLからメタデータを取得する関数
async function fetchSiteMetadata(targetUrl: string) {
  try {
    const response = await fetch(targetUrl, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (compatible; LinkCardBot/1.0)',
      },
    });

    if (!response.ok) {
      throw new Error(`取得できませんでした: ${response.status} ${response.statusText}`);
    }

    const html = await response.text();

    const titleMatch = html.match(/<title[^>]*>([^<]+)<\/title>/i);
    const descriptionMatch =
      html.match(/<meta[^>]*name=['"]description['"][^>]*content=['"]([^'"]+)['"]/i) ||
      html.match(/<meta[^>]*property=['"]og:description['"][^>]*content=['"]([^'"]+)['"]/i);
    const ogImageMatch = html.match(/<meta[^>]*property=['"]og:image['"][^>]*content=['"]([^'"]+)['"]/i);
    const siteNameMatch = html.match(/<meta[^>]*property=['"]og:site_name['"][^>]*content=['"]([^'"]+)['"]/i);
    const faviconMatch = html.match(/<link[^>]*rel=['"](?:shortcut )?icon['"][^>]*href=['"]([^'"]+)['"]/i);

    const domain = new URL(targetUrl).hostname;

    return {
      title: titleMatch ? titleMatch[1].trim() : domain,
      description: descriptionMatch ? descriptionMatch[1].trim() : '',
      thumbnail: ogImageMatch ? ogImageMatch[1] : null,
      siteName: siteNameMatch ? siteNameMatch[1].trim() : domain,
      faviconUrl: faviconMatch ? new URL(faviconMatch[1], targetUrl).toString() : null,
    };
  } catch (error) {
    console.error('メタデータ取得エラー:', error);

    const domain = targetUrl.replace(/^https?:\/\//, '').replace(/\/.*$/, '');
    return {
      title: domain,
      description: 'このサイトの情報を取得できませんでした',
      thumbnail: null,
      siteName: domain,
      faviconUrl: null,
    };
  }
}

// メタデータを取得
const metadata = await fetchSiteMetadata(url);
---

<div class="my-6 w-full">
  <a 
    href={url} 
    target="_blank" 
    rel="noopener noreferrer"
    class="linkcard-container block w-full mx-auto rounded-lg border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow duration-200 overflow-hidden bg-white dark:bg-gray-800"
  >
    <!-- サムネイル画像（左側） -->
    <div class="w-[35%] bg-gray-100 dark:bg-gray-700 h-full flex justify-center items-center overflow-hidden">
      <img 
        src={metadata.thumbnail || "/images/ryokatsu.jpg"} 
        alt="" 
        class="w-full h-full object-contain p-2"
        loading="lazy"
      />
    </div>
    
    <!-- テキスト情報（右側） -->
    <div class="w-[65%] p-5 flex flex-col justify-between h-full">
      <!-- タイトル -->
      <div class="text-lg font-bold text-gray-900 dark:text-gray-100 line-clamp-2 mb-2">
        {metadata.title}
      </div>
      
      <!-- 説明 -->
      <div class="text-sm text-gray-600 dark:text-gray-300 line-clamp-3 mb-auto">
        {metadata.description}
      </div>
      
      <!-- サイト情報 -->
      <div class="flex items-center mt-3 text-xs text-gray-500 dark:text-gray-400">
        {metadata.faviconUrl && 
          <img 
            src={metadata.faviconUrl} 
            alt="" 
            class="w-4 h-4 mr-2 rounded"
            width="16"
            height="16"
          />
        }
        <span>{metadata.siteName}</span>
      </div>
    </div>
  </a>
</div>

<style>
  .linkcard-container {
    display: flex;
    text-decoration: none !important;
    color: inherit;
    height: 180px;
    max-height: 180px;
  }
  
  .linkcard-container:hover {
    text-decoration: none !important;
    color: inherit;
  }
  
  .linkcard-container * {
    text-decoration: none !important;
  }
  
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;  
    overflow: hidden;
  }
  
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;  
    overflow: hidden;
  }
</style> 