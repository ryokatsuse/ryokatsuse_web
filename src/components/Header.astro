---
import { SITE_TITLE } from '../config';
---

<header id="site-header" class="bg-neutral-800 fixed top-0 left-0 right-0 z-40 transition-transform duration-300">
  <div class="flex items-center justify-between max-w-3xl m-auto p-4">
    <a
      class="flex items-center gap-x-2 w-fit text-white"
      href={Astro.url.pathname !== '/' ? '/' : null}
      rel="prefetch"
    >
      <img class="w-7 rounded-full bg-white" src="/images/ryokatsu.jpg" width="48" height="48" alt="" decoding="async" />
      {SITE_TITLE}
    </a>
    <div class="flex gap-x-4 items-center">
      <button 
        id="search-toggle" 
        class="text-white hover:text-gray-300 flex items-center" 
        aria-label="検索を開く"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </button>
      <ul class="flex gap-x-4 items-center">
        <li>
          <a class="text-white hover:text-gray-300 flex items-center" href="/posts-feed.xml" title="RSS Feed">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss">
              <path d="M4 11a9 9 0 0 1 9 9"></path>
              <path d="M4 4a16 16 0 0 1 16 16"></path>
              <circle cx="5" cy="19" r="1"></circle>
            </svg>
          </a>
        </li>
        <li>
          <button
            id="theme-toggle"
            class="text-white hover:text-gray-300 flex items-center"
            aria-label="テーマを切り替える"
          >
            <!-- 太陽アイコン（ダークモード時に表示） -->
            <svg id="sun-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="5"></circle>
              <line x1="12" y1="1" x2="12" y2="3"></line>
              <line x1="12" y1="21" x2="12" y2="23"></line>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
              <line x1="1" y1="12" x2="3" y2="12"></line>
              <line x1="21" y1="12" x2="23" y2="12"></line>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
            <!-- 月アイコン（ライトモード時に表示） -->
            <svg id="moon-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
          </button>
        </li>
      </ul>
    </div>
  </div>
</header>

<!-- 検索モーダル -->
<div id="search-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center">
  <div class="relative w-full max-w-3xl mx-auto px-4">
    <div class="bg-neutral-800 rounded-lg shadow-xl p-6">
      <div class="flex items-center mb-4">
        <svg class="text-white mr-3" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input 
          type="text" 
          id="search-input" 
          placeholder="記事を検索..." 
          class="w-full px-3 py-2 rounded text-sm bg-neutral-700 text-white border border-neutral-600 focus:outline-none focus:border-neutral-500"
        />
        <button id="close-search" class="ml-3 text-white hover:text-gray-300">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div id="search-results" class="max-h-60vh overflow-y-auto"></div>
    </div>
  </div>
</div>

<script>
  // テーマ切り替え
  const themeToggle = document.getElementById('theme-toggle') as HTMLButtonElement;
  const sunIcon = document.querySelector('#sun-icon') as Element;
  const moonIcon = document.querySelector('#moon-icon') as Element;

  const updateThemeIcons = () => {
    const isDark = document.documentElement.classList.contains('dark');
    sunIcon.classList.toggle('hidden', !isDark);
    moonIcon.classList.toggle('hidden', isDark);
  };

  // 初期表示
  updateThemeIcons();

  themeToggle.addEventListener('click', () => {
    const isDark = document.documentElement.classList.toggle('dark');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    updateThemeIcons();
  });

  // ヘッダーのスクロール制御
  const header = document.getElementById('site-header') as HTMLElement;
  const scrollState = { lastScrollY: window.scrollY, ticking: false };

  const updateHeader = (state: typeof scrollState) => () => {
    const currentScrollY = window.scrollY;

    if (currentScrollY <= 0) {
      // ページ最上部では常に表示
      header.style.transform = 'translateY(0)';
    } else if (currentScrollY > state.lastScrollY) {
      // 下にスクロール時は隠す
      header.style.transform = 'translateY(-100%)';
    } else {
      // 上にスクロール時は表示
      header.style.transform = 'translateY(0)';
    }

    state.lastScrollY = currentScrollY;
    state.ticking = false;
  };

  window.addEventListener('scroll', () => {
    if (!scrollState.ticking) {
      window.requestAnimationFrame(updateHeader(scrollState));
      scrollState.ticking = true;
    }
  });

  // 分離したロジックを使用する
  import { fetchBlogPosts, searchPosts, generateSearchResultsHtml, type BlogPost } from '../lib/search';

  const searchToggle = document.getElementById('search-toggle') as HTMLButtonElement;
  const searchModal = document.getElementById('search-modal') as HTMLDivElement;
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const searchResultsElement = document.getElementById('search-results') as HTMLDivElement;
  const closeSearch = document.getElementById('close-search') as HTMLButtonElement;
  
  let blogPosts: BlogPost[] = [];
  let isDataLoaded = false;

  // 検索結果を表示
  const showSearchResults = (query: string): void => {
    if (!query.trim()) {
      searchResultsElement.innerHTML = '';
      return;
    }

    if (!isDataLoaded) {
      searchResultsElement.innerHTML = '<div class="p-3 text-white">データを読み込み中...</div>';
      return;
    }

    // 分離したロジックを使用して検索を実行
    const filteredPosts = searchPosts(blogPosts, query);
    
    // 検索結果からHTMLを生成
    searchResultsElement.innerHTML = generateSearchResultsHtml(filteredPosts);
  };

  // モーダルを開く
  const openSearchModal = async (): Promise<void> => {
    searchModal.classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
    searchInput.focus();
    
    if (!isDataLoaded) {
      blogPosts = await fetchBlogPosts();
      isDataLoaded = true;
    }
  };

  // モーダルを閉じる
  const closeSearchModal = (): void => {
    searchModal.classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
    searchInput.value = '';
    searchResultsElement.innerHTML = '';
  };

  // イベントリスナーの設定
  searchToggle.addEventListener('click', openSearchModal);
  closeSearch.addEventListener('click', closeSearchModal);
  searchInput.addEventListener('input', () => showSearchResults(searchInput.value));

  // ESCキーでモーダルを閉じる
  document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape' && !searchModal.classList.contains('hidden')) {
      closeSearchModal();
    }
  });

  // モーダル外をクリックしたら閉じる
  searchModal.addEventListener('click', (event) => {
    if (event.target === searchModal) {
      closeSearchModal();
    }
  });
</script>

<style>
  #search-modal {
    backdrop-filter: blur(4px);
  }

  #search-results {
    max-height: 60vh;
  }

  @media (max-width: 640px) {
    #search-results {
      max-height: 40vh;
    }
  }
</style>
