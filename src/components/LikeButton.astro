---
interface Props {
  slug: string;
}

const { slug } = Astro.props;
---

<button
  class="like-button flex items-center gap-1 px-2 py-1 rounded-full transition-colors hover:bg-pink-50 dark:hover:bg-pink-900/30 cursor-pointer"
  data-slug={slug}
  aria-label="いいね"
>
  <svg
    xmlns="http://www.w3.org/2000/svg"
    class="w-5 h-5 text-gray-500 dark:text-gray-400 like-icon transition-colors"
    viewBox="0 0 24 24"
    stroke="currentColor"
    stroke-width="2"
    fill="none"
  >
    <path
      stroke-linecap="round"
      stroke-linejoin="round"
      d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
    />
  </svg>
  <span class="like-count text-sm text-gray-600 dark:text-gray-400 opacity-0 transition-opacity"></span>
</button>

<script>
  const STORAGE_KEY = 'liked_articles';

  const getLikedSlugs = (): string[] => {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      return stored ? JSON.parse(stored) : [];
    } catch {
      return [];
    }
  };

  const setLikedSlugs = (slugs: string[]) => {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(slugs));
  };

  const updateUI = (button: HTMLElement, count: number, hasLiked: boolean) => {
    const icon = button.querySelector('.like-icon');
    const countEl = button.querySelector('.like-count');

    if (countEl) {
      countEl.textContent = count.toString();
      countEl.classList.remove('opacity-0');
      countEl.classList.add('opacity-100');
    }

    if (icon) {
      if (hasLiked) {
        icon.classList.add('text-pink-500', 'fill-pink-500');
        icon.classList.remove('text-gray-500', 'dark:text-gray-400');
      } else {
        icon.classList.remove('text-pink-500', 'fill-pink-500');
        icon.classList.add('text-gray-500', 'dark:text-gray-400');
      }
    }

    if (hasLiked) {
      button.classList.add('liked');
    } else {
      button.classList.remove('liked');
    }
  };

  const initLikeButton = async (button: HTMLElement) => {
    const slug = button.dataset.slug;
    if (!slug) return;

    // ローカルストレージからいいね状態を取得
    const likedSlugs = getLikedSlugs();
    const hasLiked = likedSlugs.includes(slug);

    // DBからカウントを取得
    try {
      const res = await fetch(`/api/likes/get?slug=${encodeURIComponent(slug)}`);
      if (res.ok) {
        const { count } = await res.json();
        updateUI(button, count, hasLiked);
      }
    } catch (e) {
      console.error('Failed to get like count:', e);
    }

    // クリックでトグル
    button.addEventListener('click', async () => {
      const currentLikedSlugs = getLikedSlugs();
      const currentHasLiked = currentLikedSlugs.includes(slug);
      const action = currentHasLiked ? 'unlike' : 'like';

      try {
        const res = await fetch('/api/likes/toggle', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ slug, action }),
        });
        if (res.ok) {
          const { count } = await res.json();
          const newHasLiked = !currentHasLiked;

          // ローカルストレージを更新
          if (newHasLiked) {
            setLikedSlugs([...currentLikedSlugs, slug]);
          } else {
            setLikedSlugs(currentLikedSlugs.filter(s => s !== slug));
          }

          updateUI(button, count, newHasLiked);
        }
      } catch (e) {
        console.error('Failed to toggle like:', e);
      }
    });
  };

  document.querySelectorAll<HTMLElement>('.like-button').forEach(initLikeButton);
</script>
